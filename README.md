# Hyperliquid 用户平均持仓时间计算器

## 项目简介

这是一个用于分析 Hyperliquid 去中心化交易所用户交易行为的 Python 脚本。它可以计算用户在各个币种上的平均持仓时间，帮助了解交易策略和持仓习惯。

## 功能特性

- 📊 **获取交易记录**：通过 Hyperliquid API 获取用户的完整成交记录
- ⏱️ **持仓时间计算**：使用 FIFO（先进先出）算法计算每笔交易的持仓时间
- 📈 **多维度统计**：
  - 简单平均持仓时间（不考虑仓位大小）
  - 加权平均持仓时间（按仓位大小加权）
  - 最短/最长持仓时间
  - 平仓次数和总平仓量
- 🎯 **分币种分析**：为每个交易的币种单独计算统计数据
- 📋 **总体概览**：提供跨所有币种的总体统计信息
- 💼 **未平仓位追踪**：显示当前所有未平仓的持仓

## 技术原理

### 持仓时间计算逻辑

脚本使用 **FIFO（先进先出）** 算法来匹配开仓和平仓：

1. **开仓处理**：当检测到开仓交易（方向包含 "Open"）时，将开仓信息（时间、数量、价格）加入该币种的持仓队列
2. **平仓处理**：当检测到平仓交易时，从队列头部开始匹配最早的开仓记录
3. **部分平仓**：支持部分平仓的情况，会相应地减少持仓队列中的数量
4. **持仓时间**：计算从开仓到平仓的时间差（以小时为单位）

### 数据流程

```
用户地址 → Hyperliquid API → 成交记录 → 时间排序 → FIFO 匹配 → 统计计算 → 结果输出
```

## 安装依赖

项目使用 Python 3.12+ 和 `uv` 包管理器。

### 使用 uv（推荐）

```bash
# 安装 uv（如果尚未安装）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 同步依赖
uv sync
```

### 使用 pip

```bash
pip install requests>=2.32.5
```

## 使用方法

### 基本使用

```bash
# 使用 uv 运行
uv run script.py

# 或者直接使用 Python
python script.py
```

### 修改用户地址

编辑 `script.py` 文件，修改第 174 行的用户地址：

```python
user_address = "0x5c9c9ab381c841530464ef9ee402568f84c3b676"  # 替换为目标地址
```

## 输出示例

```
正在获取用户 0x5c9c9ab381c841530464ef9ee402568f84c3b676 的交易记录...

成功获取 150 条交易记录

================================================================================
持仓时间统计报告
================================================================================

【BTC】
--------------------------------------------------------------------------------
  平仓次数: 25
  简单平均持仓时间: 3.5 小时
  加权平均持仓时间: 4.2 小时 (按仓位大小加权)
  最短持仓时间: 15.3 分钟
  最长持仓时间: 2.3 天
  总平仓量: 1.5000

【ETH】
--------------------------------------------------------------------------------
  平仓次数: 30
  简单平均持仓时间: 2.8 小时
  加权平均持仓时间: 3.1 小时 (按仓位大小加权)
  最短持仓时间: 8.5 分钟
  最长持仓时间: 1.5 天
  总平仓量: 25.0000

================================================================================
【总体统计】
--------------------------------------------------------------------------------
  总平仓次数: 55
  总体简单平均持仓时间: 3.1 小时
  总体加权平均持仓时间: 3.6 小时

================================================================================
【当前未平仓位】
--------------------------------------------------------------------------------
  BTC: 0.5000 (共 2 个开仓记录)
  ETH: 10.0000 (共 1 个开仓记录)
```

## 代码结构

### 主要函数

#### `fetch_user_fills(user_address)`
- **功能**：从 Hyperliquid API 获取用户的成交记录
- **参数**：`user_address` - 用户的钱包地址（以太坊地址格式）
- **返回**：成交记录的 JSON 数组
- **异常**：如果 API 请求失败会抛出 `requests.exceptions.RequestException`

#### `calculate_average_holding_time(fills)`
- **功能**：计算每个币种的平均持仓时间
- **参数**：`fills` - 成交记录数组
- **返回**：
  - `holding_times`: 字典，键为币种，值为持仓时间记录列表
  - `positions`: 字典，键为币种，值为未平仓的持仓队列
- **算法**：FIFO（先进先出）

#### `format_time(hours)`
- **功能**：将小时数格式化为易读的时间字符串
- **参数**：`hours` - 小时数（浮点数）
- **返回**：格式化的时间字符串（分钟/小时/天）

#### `print_statistics(holding_times, positions)`
- **功能**：打印详细的统计报告
- **参数**：
  - `holding_times` - 持仓时间记录
  - `positions` - 未平仓持仓记录
- **输出**：控制台打印统计报告

#### `main()`
- **功能**：程序主入口，协调各个函数的执行
- **流程**：获取数据 → 计算统计 → 输出报告

## 数据模型

### 成交记录（Fill）结构

```python
{
    'coin': str,      # 币种名称，如 "BTC", "ETH"
    'sz': str,        # 成交数量（字符串格式）
    'time': int,      # 时间戳（毫秒）
    'dir': str,       # 方向，包含 "Open" 表示开仓，否则为平仓
    'px': str         # 成交价格（字符串格式）
}
```

### 持仓记录结构

```python
{
    'time': int,              # 开仓时间（毫秒时间戳）
    'size': float,            # 持仓数量
    'price': float            # 开仓价格
}
```

### 持仓时间记录结构

```python
{
    'holding_time_hours': float,  # 持仓时间（小时）
    'size': float,                 # 平仓数量
    'open_time': int,              # 开仓时间（毫秒时间戳）
    'close_time': int              # 平仓时间（毫秒时间戳）
}
```

## API 说明

### Hyperliquid API 端点

- **URL**: `https://api.hyperliquid.xyz/info`
- **方法**: POST
- **请求体**:
  ```json
  {
    "aggregateByTime": true,
    "type": "userFills",
    "user": "0x..."
  }
  ```

### API 限制

- 无需认证即可获取公开的用户交易数据
- 请遵守 Hyperliquid 的 API 使用限制

## 应用场景

1. **交易策略分析**：了解自己的平均持仓时间，评估是否符合预期策略
2. **风险管理**：通过持仓时间分布了解风险暴露情况
3. **交易习惯优化**：识别不同币种的持仓模式差异
4. **绩效评估**：结合持仓时间和收益率进行更深入的绩效分析
5. **用户研究**：分析其他用户的交易行为（仅限公开数据）

## 注意事项

1. **数据准确性**：计算基于 Hyperliquid API 返回的数据，确保 API 数据完整
2. **FIFO 假设**：脚本使用 FIFO 算法，可能与实际的仓位匹配策略有差异
3. **未平仓位**：当前未平仓的持仓不会计入平均持仓时间统计
4. **时间精度**：时间计算基于毫秒级时间戳，精度足够
5. **隐私考虑**：用户地址和交易数据都是区块链上的公开信息

## 常见问题

### Q: 为什么计算结果与交易所显示不一致？

A: 可能的原因：
- 交易所可能使用不同的仓位匹配算法（如 LIFO 或加权平均）
- API 数据可能存在延迟或不完整
- 部分交易可能未被 API 返回

### Q: 如何处理多次开平仓的复杂情况？

A: 脚本使用 FIFO 队列自动处理：
- 每次开仓都会加入队列
- 每次平仓都会从队列头部开始匹配
- 支持部分平仓的场景

### Q: 可以分析其他用户的数据吗？

A: 可以，只需替换用户地址。所有数据都是区块链上的公开信息。

### Q: 加权平均和简单平均有什么区别？

A: 
- **简单平均**：所有平仓交易的持仓时间算术平均，每笔交易权重相同
- **加权平均**：按仓位大小加权，大仓位的持仓时间影响更大

## 技术栈

- **Python**: 3.12+
- **requests**: HTTP 请求库，用于 API 调用
- **uv**: 现代化的 Python 包管理器

## 许可证

请根据项目需要添加合适的许可证。

## 贡献

欢迎提交 Issue 和 Pull Request！

## 更新日志

### v0.1.0
- 初始版本
- 实现基本的持仓时间计算功能
- 支持 FIFO 算法
- 提供详细的统计报告

---

**开发者提示**：代码注释使用中文，便于中文开发者理解和维护。

